<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-image: url('https://www.dublincleaners.com/wp-content/uploads/2025/06/redbg.jpg');
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .header { display: flex; align-items: center; justify-content: space-between; background-color: #b30000; color: white; padding: 20px; }
      .header img { height: 120px; }
      .header-title { text-align: center; flex-grow: 1; }
      .header-title h1 { margin: 0; font-size: 36px; color: #ffffff; }
      .header-title .datetime { font-size: 18px; margin-top: 8px; color: #ffd1d1; }
      .weather { text-align: right; color: #ffd1d1; }
      .weather div { line-height: 1.2; }
      .add-frame-btn { margin-top: 8px; padding: 6px 12px; background-color: #ffffff; color: #b30000; border: none; cursor: pointer; }
      .add-frame-btn:hover { background-color: #ffd1d1; }
      .viewing-area {
        position: relative;
        flex: 1;
        overflow: hidden;
        background-color: transparent;
      }
      .frame {
        position: absolute;
        border: 5px solid #b30000;
        background: #fff;
        box-sizing: border-box;
        cursor: crosshair;
        font-size: 133%;
      }
      .frame-header {
        background: #333;
        color: #fff;
        padding: 2px 24px 2px 4px;
        cursor: crosshair;
        position: relative;
        text-align: center;
        user-select: none;
      }
      .frame-title {
        width: 100%;
        outline: none;
        text-align: center;
        cursor: text;
      }
      .close-btn {
        position: absolute;
        right: 2px;
        top: 2px;
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 21px;
      }
      .frame .resizer {
        width: 10px;
        height: 10px;
        background: #333;
        position: absolute;
        right: 0;
        bottom: 0;
        cursor: se-resize;
      }
      .weekly-quote {
        position: fixed;
        bottom: 10px;
        right: 10px;
        color: #ffffff;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px 12px;
        font-style: italic;
        font-size: 14px;
        border-radius: 4px;
      }
      .driver-overlay {
        position: fixed;
        bottom: 80px;
        right: 10px;
        width: 275px;
        pointer-events: none;
        z-index: 1000;
      }
      .driver-overlay img {
        width: 100%;
        height: auto;
        display: block;
        opacity: 1;
        transition: opacity 2s ease;
        mask-image: radial-gradient(circle at center, black 85%, transparent 100%);
        -webkit-mask-image: radial-gradient(circle at center, black 85%, transparent 100%);
        mask-size: cover;
        -webkit-mask-size: cover;
      }
      .driver-overlay img.fade-out {
        opacity: 0;
      }
      .driver-overlay img.animate {
        mask-image:
          radial-gradient(circle at center, black 85%, transparent 100%),
          repeating-linear-gradient(
            to right,
            black 0,
            black 10px,
            transparent 10px,
            transparent 20px
          );
        -webkit-mask-image:
          radial-gradient(circle at center, black 85%, transparent 100%),
          repeating-linear-gradient(
            to right,
            black 0,
            black 10px,
            transparent 10px,
            transparent 20px
          );
        mask-size: cover, 200% 100%;
        -webkit-mask-size: cover, 200% 100%;
        mask-position: center, -100% 0;
        -webkit-mask-position: center, -100% 0;
        animation: maskSlideReverse 2s linear forwards;
      }
      @keyframes maskSlideReverse {
        from {
          mask-position: center, -100% 0;
          -webkit-mask-position: center, -100% 0;
        }
        to {
          mask-position: center, 0 0;
          -webkit-mask-position: center, 0 0;
        }
      }
    </style>
    <script>
      function updateDateTime() {
        var now = new Date();
        document.getElementById('datetime').textContent = now.toLocaleString();
      }

      function updateWeather(data) {
        if (data) {
          document.getElementById('weather-temp').textContent = 'Temp: ' + data.temperature + 'Â°C';
          document.getElementById('weather-condition').textContent = data.condition;
        } else {
          document.getElementById('weather-temp').textContent = '';
          document.getElementById('weather-condition').textContent = 'Weather unavailable';
        }
      }

      function init() {
        updateDateTime();
        setInterval(updateDateTime, 1000);
        updateQuote();
        // refresh quote once a day
        setInterval(updateQuote, 86400000);
        google.script.run.withSuccessHandler(updateWeather).getWeather();
        google.script.run.withSuccessHandler(loadFrames).getFrames();
        document.getElementById('add-frame').addEventListener('click', addFrame);
      }

      var frames = [];
      var zIndex = 1;

      function updateQuote() {
        google.script.run.withSuccessHandler(function(text) {
          document.getElementById('weekly-quote').textContent = text;
        }).getRandomQuote();
      }

      function loadFrames(data) {
        frames = data || [];
        frames.forEach(function(f, i) { createFrame(f, i); });
      }

      function saveFrames() {
        google.script.run.saveFrames(frames);
      }

      function addFrame() {
        var frame = { x: 10, y: 10, width: 200, height: 150, title: 'Frame' };
        frames.push(frame);
        createFrame(frame, frames.length - 1);
        saveFrames();
      }

      function createFrame(frame, index) {
        var area = document.getElementById('viewing-area');
        var div = document.createElement('div');
        div.className = 'frame';
        div.style.left = frame.x + 'px';
        div.style.top = frame.y + 'px';
        div.style.width = frame.width + 'px';
        div.style.height = frame.height + 'px';
        div.dataset.index = index;
        div.style.zIndex = zIndex++;

        var header = document.createElement('div');
        header.className = 'frame-header';
        var title = document.createElement('div');
        title.className = 'frame-title';
        title.contentEditable = true;
        title.textContent = frame.title || 'Frame';
        header.appendChild(title);
        var close = document.createElement('button');
        close.className = 'close-btn';
        close.textContent = '\u00D7';
        header.appendChild(close);
        div.appendChild(header);

        var resizer = document.createElement('div');
        resizer.className = 'resizer';
        div.appendChild(resizer);

        title.addEventListener('input', function() {
          frames[parseInt(div.dataset.index, 10)].title = title.textContent;
          saveFrames();
        });

        close.addEventListener('click', function(e) {
          e.stopPropagation();
          var idx = parseInt(div.dataset.index, 10);
          frames.splice(idx, 1);
          area.removeChild(div);
          updateFrameIndices();
          saveFrames();
        });

        area.appendChild(div);

        enableDrag(div);
        enableResize(div, resizer);
      }

      function updateFrameIndices() {
        var children = document.querySelectorAll('.viewing-area .frame');
        children.forEach(function(c, i) { c.dataset.index = i; });
      }

      function enableDrag(el) {
        var startX, startY, startLeft, startTop, idx;

        el.addEventListener('mousedown', function(e) {
          if (e.target.classList.contains('resizer') ||
              e.target.classList.contains('frame-title')) return;
          e.preventDefault();
          idx = parseInt(el.dataset.index, 10);
          startX = e.clientX;
          startY = e.clientY;
          startLeft = el.offsetLeft;
          startTop = el.offsetTop;
          el.style.zIndex = zIndex++;
          function move(ev) {
            var area = document.getElementById('viewing-area');
            var rect = area.getBoundingClientRect();
            var x = startLeft + ev.clientX - startX;
            var y = startTop + ev.clientY - startY;
            x = Math.max(0, Math.min(x, rect.width - el.offsetWidth));
            y = Math.max(0, Math.min(y, rect.height - el.offsetHeight));
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            frames[idx].x = x;
            frames[idx].y = y;
          }
          function up() {
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', up);
            saveFrames();
          }
          document.addEventListener('mousemove', move);
          document.addEventListener('mouseup', up);
        });
      }

      function enableResize(el, handle) {
        var startX, startY, startW, startH, idx;

        handle.addEventListener('mousedown', function(e) {
          e.stopPropagation();
          idx = parseInt(el.dataset.index, 10);
          startX = e.clientX;
          startY = e.clientY;
          startW = el.offsetWidth;
          startH = el.offsetHeight;
          el.style.zIndex = zIndex++;
          function move(ev) {
            var area = document.getElementById('viewing-area');
            var rect = area.getBoundingClientRect();
            var width = startW + ev.clientX - startX;
            var height = startH + ev.clientY - startY;
            width = Math.max(50, Math.min(width, rect.width - el.offsetLeft));
            height = Math.max(50, Math.min(height, rect.height - el.offsetTop));
            el.style.width = width + 'px';
            el.style.height = height + 'px';
            frames[idx].width = width;
            frames[idx].height = height;
          }
          function up() {
            document.removeEventListener('mousemove', move);
            document.removeEventListener('mouseup', up);
            saveFrames();
          }
          document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', up);
      });
      }

      function keepFramesInView() {
        var area = document.getElementById('viewing-area');
        var rect = area.getBoundingClientRect();
        var children = document.querySelectorAll('.viewing-area .frame');
        children.forEach(function(el) {
          var idx = parseInt(el.dataset.index, 10);
          var x = Math.max(0, Math.min(el.offsetLeft, rect.width - el.offsetWidth));
          var y = Math.max(0, Math.min(el.offsetTop, rect.height - el.offsetHeight));
          var width = Math.max(50, Math.min(el.offsetWidth, rect.width - x));
          var height = Math.max(50, Math.min(el.offsetHeight, rect.height - y));
          el.style.left = x + 'px';
          el.style.top = y + 'px';
          el.style.width = width + 'px';
          el.style.height = height + 'px';
          frames[idx].x = x;
          frames[idx].y = y;
          frames[idx].width = width;
          frames[idx].height = height;
        });
        saveFrames();
      }

      window.addEventListener('resize', keepFramesInView);

      function startDriverAnimation() {
        var img = document.getElementById('driver-img');
        if (!img) return;
        img.classList.remove('animate');
        void img.offsetWidth;
        img.classList.add('animate');
        img.addEventListener('animationend', function handler() {
          img.classList.remove('animate');
          img.removeEventListener('animationend', handler);
        });
      }

      function fadeAndAnimate() {
        var img = document.getElementById('driver-img');
        if (!img) return;
        img.classList.add('fade-out');
        setTimeout(function() {
          img.classList.remove('fade-out');
          startDriverAnimation();
        }, 2000);
      }

      document.addEventListener('DOMContentLoaded', function() {
        startDriverAnimation();
        setInterval(fadeAndAnimate, 30000);
      });
    </script>
  </head>
  <body onload="init()">
    <div class="header">
      <div class="logo">
        <img src="https://www.dublincleaners.com/wp-content/uploads/2025/06/LogosHQ.png" alt="Logo">
      </div>
      <div class="header-title">
        <h1>Route Operations Dashboard</h1>
        <div id="datetime" class="datetime"></div>
      </div>
      <div id="weather" class="weather">
        <div id="weather-temp"></div>
        <div id="weather-condition"></div>
        <button id="add-frame" class="add-frame-btn">Add Frame</button>
      </div>
    </div>
    <div id="viewing-area" class="viewing-area"></div>
    <div class="driver-overlay">
      <img id="driver-img" src="https://www.dublincleaners.com/wp-content/uploads/2025/06/Driver7.png" alt="Driver">
    </div>
    <div id="weekly-quote" class="weekly-quote"></div>
  </body>
</html>
